# Install iredmail jail
# Note: if you want to get the service quickly, please use the image from the marketplace (which is generated by this file): https://marketplace.convectix.com
# iRedMain for FreeBSD is builded strictly from ports and can take several hours, details:
# - 1) https://forum.iredmail.org/topic17822-freebsd-ports-instead-of-pkgs.html
# - 2) https://docs.iredmail.org/install.iredmail.on.freebsd.html
#
# Some defaults:
# Set iRedMail version to install: https://github.com/iredmail/iRedMail/tags
IREDMAIL_VER="1.6.2"
STORAGE_BASE_DIR='/var/vmail'
WEB_SERVER='NGINX'
BACKEND_ORIG='MARIADB'
BACKEND='MYSQL'
VMAIL_DB_BIND_PASSWD=$( random_password_gen -l 32 )
VMAIL_DB_ADMIN_PASSWD=$( random_password_gen -l 32 )
MLMMJADMIN_API_AUTH_TOKEN=$( random_password_gen -l 32 )
NETDATA_DB_PASSWD=$( random_password_gen -l 32 )
MYSQL_ROOT_PASSWD=$( random_password_gen -l 32 )
FIRST_DOMAIN='example.com'
DOMAIN_ADMIN_PASSWD_PLAIN=$( random_password_gen -l 32 )
USE_IREDADMIN='YES'
USE_ROUNDCUBE='YES'
AMAVISD_DB_PASSWD=$( random_password_gen -l 32 )
IREDADMIN_DB_PASSWD=$( random_password_gen -l 32 )
RCM_DB_PASSWD=$( random_password_gen -l 32 )
SOGO_DB_PASSWD=$( random_password_gen -l 32 )
SOGO_SIEVE_MASTER_PASSWD=$( random_password_gen -l 32 )
IREDAPD_DB_PASSWD=$( random_password_gen -l 32 )
FAIL2BAN_DB_PASSWD=$( random_password_gen -l 32 )

jail_iredmail1()
{
	ip4_addr="10.0.100.155"
	host_hostname="${jname}.convectix.com"
	pkg_bootstrap=1
	baserw=1
	mount_src=1		# for lsof
	vnet=1			# req for MySQL Grant
	pkglist="shells/bash"
}

postcreate_iredmail1()
{
	# turn off unnecessary services
	sysrc jname=${jname} \
		syslogd_enable="NO" \
		cron_enable="NO" \
		sendmail_enable="NO" \
		sendmail_submit_enable="NO"\
		sendmail_outbound_enable="NO" \
		sendmail_msp_queue_enable="NO" \
		sshd_enable="NO" \
		sshd_flags="-oUseDNS=no" \
		syslogd_flags="-ss -c"

	jexec /bin/sh <<JEXEC
export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/root/bin
#service cron onestop
#service syslogd onestop
/etc/rc.d/netif restart
/sbin/route add default 10.0.100.1


[ -d /root/iRedMail-${IREDMAIL_VER} ] && exit 0
cd /root
fetch -o /root/${IREDMAIL_VER}.tar.gz https://codeload.github.com/iredmail/iRedMail/tar.gz/refs/tags/${IREDMAIL_VER}
tar xfz ${IREDMAIL_VER}.tar.gz

# re-generate config ( we need #EOF at the end of config - iRedMail req.)
cat > /root/iRedMail-${IREDMAIL_VER}/config <<XEOF

STORAGE_BASE_DIR='${STORAGE_BASE_DIR}'
WEB_SERVER='${WEB_SERVER}'
BACKEND_ORIG='${BACKEND_ORIG}'
BACKEND='${BACKEND}'
VMAIL_DB_BIND_PASSWD='${VMAIL_DB_BIND_PASSWD}'
VMAIL_DB_ADMIN_PASSWD='${VMAIL_DB_ADMIN_PASSWD}'
MLMMJADMIN_API_AUTH_TOKEN='${MLMMJADMIN_API_AUTH_TOKEN}'
NETDATA_DB_PASSWD='${NETDATA_DB_PASSWD}'
MYSQL_ROOT_PASSWD='${MYSQL_ROOT_PASSWD}'
FIRST_DOMAIN='${FIRST_DOMAIN}'
DOMAIN_ADMIN_PASSWD_PLAIN='${DOMAIN_ADMIN_PASSWD_PLAIN}'
USE_IREDADMIN='${USE_IREDADMIN}'
USE_ROUNDCUBE='${USE_ROUNDCUBE}'
AMAVISD_DB_PASSWD='${AMAVISD_DB_PASSWD}'
IREDADMIN_DB_PASSWD='${IREDADMIN_DB_PASSWD}'
RCM_DB_PASSWD='${RCM_DB_PASSWD}'
SOGO_DB_PASSWD='${SOGO_DB_PASSWD}'
SOGO_SIEVE_MASTER_PASSWD='${SOGO_SIEVE_MASTER_PASSWD}'
IREDAPD_DB_PASSWD='${IREDAPD_DB_PASSWD}'
FAIL2BAN_DB_PASSWD='${FAIL2BAN_DB_PASSWD}'
#EOF
XEOF


cd /root/iRedMail-${IREDMAIL_VER}/

env AUTO_USE_EXISTING_CONFIG_FILE=y AUTO_INSTALL_WITHOUT_CONFIRM=y AUTO_CLEANUP_REMOVE_SENDMAIL=y \
    AUTO_CLEANUP_REPLACE_FIREWALL_RULES=y \ AUTO_CLEANUP_RESTART_FIREWALL=y AUTO_CLEANUP_REPLACE_MYSQL_CONFIG=y \
    /usr/local/bin/bash /root/iRedMail-${IREDMAIL_VER}/iRedMail.sh
JEXEC

#        service mode=action jupyter start || true
#        echo "waiting for service..."
#        sleep 10                # waiting for service ready

	_ip=$( jget jname=${jname} mode=quiet ip4_addr )

	# postmessage
	cat <<EOF
    Roundcube webmail           : https://${FIRST_DOMAIN}/mail/       ( https://${_ip}/mail/ )
    SOGo Groupware              : https://${FIRST_DOMAIN}/SOGo        ( https://${_ip}/SOGo )
    Web admin panel (iRedAdmin) : https://${FIRST_DOMAIN}/iredadmin/  ( https://${_ip}/iredadmin/ )

    Default login: postmaster@${FIRST_DOMAIN}
    Default password: ${DOMAIN_ADMIN_PASSWD_PLAIN}
EOF

}
