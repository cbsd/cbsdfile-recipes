jail_transmission()
{
	ip4_addr="DHCP"
	host_hostname="${jname}.my.domain"
	pkg_bootstrap=1
	ver="native"

	pkglist="net-p2p/transmission transmission-web"
#	pkglist="mc python311"

	# turn off unnecessary services
	sysrc="syslogd_enable=NO cron_enable=NO sendmail_enable=NO sendmail_submit_enable=NO sendmail_outbound_enable=NO sendmail_msp_queue_enable=NO clear_tmp_enable=YES transmission_enable=YES transmission_log=/var/log/transmission.log"
}

postcreate_transmission()
{
	local _ip=

	set +o xtrace

	_ip=$( jget jname=${jname} mode=quiet ip4_addr )

	echo "DATA: ${data}"


	#jexec chown -R 850:850 /home/transmission
	# may dup
	jexec service transmission stop || true
	sleep 2

	# transmission write/save settings.json upon stop, rewrite when services is stopped
	${CP_CMD} -a ${data}/usr/local/etc/transmission/home/settings.json ${data}/usr/local/etc/transmission/home/settings.json.orig
	${SED_CMD} -i '' 's#rpc-whitelist-enabled": true,#rpc-whitelist-enabled": false,#' ${data}/usr/local/etc/transmission/home/settings.json
	${GREP_CMD} rpc-whitelist-enabled ${data}/usr/local/etc/transmission/home/settings.json

	jexec service transmission start || true

	# wait a liitle for process before tests
	sleep 8

	# postmessage
	set +o errexit  # retcode for iptype

	OIFS="${IFS}"
	IFS=","
	for i in ${_ip}; do
		IFS="${OIFS}"
		myip=
		iptype ${i}
		case $? in
			1)
				# ipv4, no cast
				myip="${i}"
				;;
			2)
				# ipv6, add brackets
				myip="[${i}]"
				;;
			*)
				# unknown IP type
				continue
				;;
			esac

		cat <<EOF
  ${jname} url          : http://${_ip}:9091

  When 'transmission-remote-gui' used, just use: ${_ip}

  To disable UI anonymous access, please edit /usr/local/etc/transmission/home/settings.json:

  "rpc-whitelist-enabled": true,

  + "rpc-whitelist" entry if necessary, e.g.: 192.168.*.*


EOF
		IFS=","
	done
	IFS="${OIFS}"
	set -o errexit
}
