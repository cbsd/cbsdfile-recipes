PY_VERSION="3.11"						# use python ${PY_VERSION} by default, e.g.: 3.11
# PHP 85 not supported yet: https://github.com/Novik/ruTorrent/issues/2992
#PHP_VERSION="85"						# use PHP ${PHP_VERSION} by default, e.g.: 85
PHP_VERSION="84"						# use PHP ${PHP_VERSION} by default, e.g.: 8
PYTHON_CMD="python${PY_VERSION}"				# default python interpreter: python${PY_VERSION}, e.g: python3.11
PIP_CMD="pip-${PY_VERSION}"					# default pip cmd: pip-${PY_VERSION}, e.g: pip-3.11
PY_PREFIX=$( echo ${PY_VERSION} | ${TR_CMD} -d "." )		# TRIM '.': 3.11 -> 311

jail_rtorrent()
{
	ip4_addr="DHCP"
	host_hostname="${jname}.my.domain"
	pkg_bootstrap=1
	ver="native"

	pkglist="python${PY_PREFIX} py${PY_PREFIX}-cloudscraper sysutils/tmux devel/git archivers/unrar archivers/rar archivers/zip multimedia/mediainfo multimedia/ffmpeg ftp/curl audio/sox php${PHP_VERSION} php${PHP_VERSION}-mbstring php${PHP_VERSION}-dom php${PHP_VERSION}-xml php${PHP_VERSION}-session php${PHP_VERSION}-fileinfo www/nginx net-p2p/rtorrent tinyxml2"

	# manage services
	sysrc="syslogd_enable=NO cron_enable=NO sendmail_enable=NO sendmail_submit_enable=NO sendmail_outbound_enable=NO sendmail_msp_queue_enable=NO clear_tmp_enable=YES php_fpm_enable=YES nginx_enable=YES rtorrent_enable=YES rtorrent_bindaddr=127.0.0.1 rtorrent_download_dir=/home/rtorrent/downloads"
}

postcreate_rtorrent()
{
	local _ip=

	set +o xtrace

	# PW ;(
	jexec <<EOF
export PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/root/bin

ln -sf /usr/local/bin/${PYTHON_CMD} /usr/local/bin/python
ln -sf /usr/local/bin/${PYTHON_CMD} /usr/local/bin/python3

if [ ! -d /home/rtorrent/rutorrent ]; then
	/usr/local/bin/git clone https://github.com/Novik/ruTorrent.git /home/rtorrent/rutorrent
fi

cp -a /home/rtorrent/config.php /home/rtorrent/rutorrent/conf/config.php
cp -a /home/rtorrent/settings.php /home/rtorrent/rutorrent/php/settings.php
cp -a /home/rtorrent/dump/conf.php /home/rtorrent/rutorrent/plugins/dump/conf.php

# https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=291382#c3 -> https://github.com/rakshasa/rtorrent/issues/1657
cp -a /home/rtorrent/rtorrent /usr/local/etc/rc.d/rtorrent

mkdir -p /home/rtorrent/downloads /home/rtorrent/session /home/rtorrent/rutorrent/php/share /home/rtorrent/rutorrent/php/share/torrents /var/nginx/client_body_temp

chown -R rtorrent:rtorrent /home/rtorrent

mkdir /var/log/nginx
touch /var/log/nginx/php.err
chown rtorrent:rtorrent /var/log/nginx/php.err

# dumptorrent plugin
pkg install -y cmake gcc
cd /root
git clone https://github.com/tomcdj71/dumptorrent
cd dumptorrent
cmake .
make
make install

EOF

	# may dup
	jexec service nginx stop 2>/dev/null || true
	jexec service php_fpm stop 2>/dev/null || true
	jexec service rtorrent stop 2>/dev/null || true
	sleep 2
	jexec service php_fpm restart || true
	jexec service rtorrent restart || true
	jexec service nginx restart || true

	# wait a little for process before tests
	sleep 8

	_ip=$( jget jname=${jname} mode=quiet ip4_addr )

	# postmessage
	set +o errexit  # retcode for iptype

	OIFS="${IFS}"
	IFS=","
	for i in ${_ip}; do
		IFS="${OIFS}"
		myip=
		iptype ${i}
		case $? in
			1)
				# ipv4, no cast
				myip="${i}"
				;;
			2)
				# ipv6, add brackets
				myip="[${i}]"
				;;
			*)
				# unknown IP type
				continue
				;;
			esac

		cat <<EOF
  ${jname} url          : http://${_ip}
EOF
		IFS=","
	done
	IFS="${OIFS}"
	set -o errexit
}
